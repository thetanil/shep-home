name: Test user-sync Feature

on:
  push:
    branches: [ main, copilot/** ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-user-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install devcontainer CLI
        run: |
          npm install -g @devcontainers/cli

      - name: Build devcontainer with user-sync feature
        run: |
          echo "Building devcontainer from trixie-slim with user-sync feature..."
          cd test-user-sync
          devcontainer up --workspace-folder .

      - name: Test user inside container
        run: |
          echo "Testing user setup inside container..."
          cd test-user-sync
          
          # Run tests inside the container
          devcontainer exec --workspace-folder . bash -c '
            echo "=========================================="
            echo "Testing user-sync feature inside container"
            echo "=========================================="
            echo ""
            
            # Check if user exists
            echo "Checking if testuser exists..."
            if id testuser &>/dev/null; then
              echo "✅ User testuser exists"
            else
              echo "❌ User testuser does not exist"
              exit 1
            fi
            
            # Check UID and GID
            USER_UID=$(id -u testuser)
            USER_GID=$(id -g testuser)
            
            echo "User UID: $USER_UID"
            echo "User GID: $USER_GID"
            
            if [ "$USER_UID" = "1000" ]; then
              echo "✅ User UID is 1000"
            else
              echo "❌ User UID is $USER_UID (expected 1000)"
              exit 1
            fi
            
            if [ "$USER_GID" = "1000" ]; then
              echo "✅ User GID is 1000"
            else
              echo "❌ User GID is $USER_GID (expected 1000)"
              exit 1
            fi
            
            # Check home directory
            echo ""
            echo "Checking home directory..."
            if [ -d "/home/testuser" ]; then
              echo "✅ Home directory /home/testuser exists"
            else
              echo "❌ Home directory /home/testuser does not exist"
              exit 1
            fi
            
            # Check ownership
            HOME_OWNER=$(stat -c "%U" /home/testuser)
            if [ "$HOME_OWNER" = "testuser" ]; then
              echo "✅ Home directory is owned by testuser"
            else
              echo "❌ Home directory is owned by $HOME_OWNER (expected testuser)"
              exit 1
            fi
            
            # Check sudo configuration
            echo ""
            echo "Checking sudo configuration..."
            if [ -f "/etc/sudoers.d/testuser" ]; then
              echo "✅ Sudoers file exists"
              
              # Check file permissions
              PERMS=$(stat -c "%a" /etc/sudoers.d/testuser)
              if [ "$PERMS" = "440" ]; then
                echo "✅ Sudoers file has correct permissions (440)"
              else
                echo "❌ Sudoers file has permissions $PERMS (expected 440)"
                exit 1
              fi
              
              # Check content
              if grep -q "testuser ALL=(ALL) NOPASSWD: ALL" /etc/sudoers.d/testuser; then
                echo "✅ Sudoers file has correct content"
              else
                echo "❌ Sudoers file does not have expected content"
                exit 1
              fi
            else
              echo "❌ Sudoers file /etc/sudoers.d/testuser does not exist"
              exit 1
            fi
            
            # Test sudo access
            echo ""
            echo "Testing sudo access..."
            # Check if user can run sudo without password by listing privileges
            if sudo -u testuser sudo -n -l 2>/dev/null | grep -q "NOPASSWD"; then
              echo "✅ User can execute sudo commands without password"
            else
              echo "❌ Sudo test failed"
              exit 1
            fi
            
            echo ""
            echo "=========================================="
            echo "✅ All tests passed!"
            echo "=========================================="
          '

      - name: Display container info
        if: always()
        run: |
          echo "Container test completed"
          cd test-user-sync
          devcontainer exec --workspace-folder . bash -c 'echo "Current user: $(whoami)" && id' || true
